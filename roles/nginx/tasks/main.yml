---

- name: Pull NGINX docker image (version {{nginx_version}})
  docker_image:
    name: nginx:{{nginx_version}}
    source: pull

# Copy files to NGINX volumes

- name: Ensure NGINX directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  loop:
    - /var/www
    - /var/nginx/conf.d
    - "/var/nginx/{{ my_domain_name|replace('.','-') }}/locations"

- name: Copy files to the server
  copy:
    src: "{{ item.src }}" 
    dest: "{{ item.dest }}"
    owner: root
    group: root
    mode: '0644'
  loop:
    - src: test.html
      dest: /var/www/test.html
    - src: robots.txt
      dest: /var/www/robots.txt
    - src: default.conf
      dest: /var/nginx/conf.d/default.conf
  notify:
    - Restart NGINX

- name: Create SSL conf file for server
  template:
    src: ssl.conf.j2
    dest: "/var/nginx/{{ my_domain_name|replace('.','-') }}/ssl.conf"
  notify:
    - Restart NGINX

- name: Create conf file for server
  template:
    src: server.conf.j2
    dest: /var/nginx/conf.d/server.conf

# Create/Start the container
  
- name: Run NGINX container
  docker_container:
    name: web-gateway
    image: nginx:{{nginx_version}}
    state: started
    networks:
      - name: "{{ network_name }}"
    ports:
      - "80:80"
      - "443:443"
    volumes:      
      - "/etc/letsencrypt:/etc/letsencrypt:ro"
      - "/var/www:/usr/share/nginx/html:ro"
      - "/var/nginx/conf.d:/etc/nginx/conf.d:ro"
      - "/var/nginx/{{ my_domain_name|replace('.','-') }}:/etc/nginx/{{ my_domain_name|replace('.','-') }}:ro"
